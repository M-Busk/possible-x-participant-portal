<!--
  Copyright 2024 Dataport. All rights reserved. Developed as part of the MERLOT project.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<div class="mb-3 flex-1" xmlns="http://www.w3.org/1999/html">
  <mat-stepper #stepper linear orientation="vertical">
    <mat-step>
      <ng-template matStepLabel>Define Offering Type</ng-template>
      <label class="form-label">Offering Type Selection</label>
      <select [(ngModel)]="offerType" class="form-select rounded-none w-full">
        <option value="service">Service Offering</option>
        <option selected value="data">Data Service Offering</option>
      </select>
      <div class="py-4 text-sm">The "Data Service Offering" consists of both a "Service Offering" and a "Data Resource".</div>
      <div class="flex justify-end">
        <button (click)="prefillWizardNewOffering()" cButton color="primary" matStepperNext shape="rounded-0"
                type="submit">Next
        </button>
      </div>
    </mat-step>

    <mat-step *ngIf="isOfferingDataOffering()" [completed]="isDataResourceValid()" errorMessage="Missing fields">
      <ng-template matStepLabel>Define Data Resource</ng-template>
      <div>
        <label class="form-label">File Name*</label>
        <input [(ngModel)]="selectedFileName" class="form-control rounded-none w-full" placeholder="e.g. MyFile.json"
               type="text">
        <div cFormText style="color: #7f7f7f;">
          Please enter the file name of the file in the S3-Bucket.
        </div>
        <div *ngIf="isInvalidFileName" class="text-error pt-2">
          <small>Filename is required.</small>
        </div>
        <br/>
      </div>
      <app-base-wizard-extension #gxDataResourceWizard></app-base-wizard-extension>
      <app-data-resource-policy-hints></app-data-resource-policy-hints>
      <div class="flex justify-between pt-4">
        <button (click)="prepareStepBeforeDataResource()" cButton color="secondary" matStepperPrevious shape="rounded-0">Back</button>
        <button (click)="prepareStepAfterDataResource()" [disabled]="!isDataResourceValid()" cButton
                color="primary"
                matStepperNext shape="rounded-0"
                type="submit">
          Next
        </button>
      </div>
    </mat-step>

    <mat-step *ngIf="isContainingPII()" [completed]="isLegitimateInterestValid()" errorMessage="Missing fields" [ngClass]="{'hidden': !isContainingPII()}">
      <ng-template matStepLabel>Define Legitimate Interest</ng-template>
      <div>
        In the previous step, it was indicated that the data contains personal identifiable information.
        It is therefore necessary to specify the legitimate interest in this additional step.
        <br/><br/>
      </div>
      <app-base-wizard-extension #gxLegitimateInterestWizard></app-base-wizard-extension>
      <div class="flex justify-between pt-4">
        <button cButton color="secondary" matStepperPrevious shape="rounded-0">Back</button>
        <button (click)="prefillServiceOfferingWizard()" [disabled]="!isLegitimateInterestValid()" cButton
                color="primary"
                matStepperNext shape="rounded-0"
                type="submit">
          Next
        </button>
      </div>
    </mat-step>

    <mat-step errorMessage="Missing fields">
      <ng-template matStepLabel>Define Service Offering</ng-template>
      <app-base-wizard-extension #gxServiceOfferingWizard></app-base-wizard-extension>
      <br/>
      <app-service-offering-policy-hints [isOfferingDataOffering]="isOfferingDataOffering()"></app-service-offering-policy-hints>
      <br/>
      <label class="form-label">POSSIBLE-X enforced policy</label>
      <div cFormText>
        Please define POSSIBLE-X enforced policies based on POSSIBLE predefined policy classes for the provided Service Offering.<br><br>
        <span *ngIf="!isAnyPolicyChecked" class="font-bold">Currently, everything is allowed.</span><br>
      </div>
      <c-accordion [flush]="true">
          <c-accordion-item #accordionItem1="cAccordionItem" [visible]="false">
            <ng-template cTemplateId="accordionHeaderTemplate">
            <div class="accordion-header" (click)="accordionItem1.toggleItem()">
              <label> Restrict the contractual booking to organization(s)</label>
              <mat-checkbox [(ngModel)]="isContractBookingPolicyChecked" (click)="handleCheckboxClick($event, 'isContractBookingPolicyChecked', accordionItem1)"></mat-checkbox>
            </div>
          </ng-template>
          <ng-template cTemplateId="accordionBody">
            <div class="accordion-body">
              <div cFormText style="color: #7f7f7f;">
                Please select the organization(s).
              </div>
              <div *ngFor="let id of contractBookingPolicyIds; let i = index; trackBy:customTrackBy" class="flex flex-col space-y-2">
                <div class="flex items-center space-x-2">
                  <select [(ngModel)]="contractBookingPolicyIds[i]" required class="form-select">
                    <option *ngFor="let id of sortedIds" [value]="id">{{ getNameIdStringById(id) }}</option>
                  </select>
                  <button (click)="addInput()" *ngIf="i === 0" cButton color="primary" size="sm" variant="ghost">
                    <svg cIcon class="" name="cib-addthis" size="xl"></svg>
                  </button>
                  <button (click)="removeInput(i)" *ngIf="i > 0" cButton color="primary" size="sm" variant="ghost">
                    <svg cIcon class="" name="cil-trash" size="xl"></svg>
                  </button>
                </div>
                <div *ngIf="!isFieldFilled(contractBookingPolicyIds[i])" style="color: red">
                  <small>
                    Please select an organization.
                  </small>
                </div>
              </div>
            </div>
          </ng-template>
        </c-accordion-item>
        <c-accordion-item #accordionItem2="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
            <div class="accordion-header"  (click)="accordionItem2.toggleItem()">
              <label> Restrict contract validity - start of contract</label>
              <mat-checkbox [(ngModel)]="isContractValidityStartPolicyChecked" (click)="handleCheckboxClick($event, 'isContractValidityStartPolicyChecked', accordionItem2)"></mat-checkbox>
            </div>
          </ng-template>
          <ng-template cTemplateId="accordionBody">
            <div class="accordion-body">
              <div cFormText style="color: #7f7f7f;">
                Please select the start date of the contract.
              </div>
              <div class="flex flex-col space-y-2">
                <mat-form-field>
                  <mat-label>Select the date</mat-label>
                  <input [ngxMatDatetimePicker]="picker" matInput [(ngModel)]="contractValidityStartDate">
                  <mat-hint>DD/MM/YYYY, HH:MM:SS</mat-hint>
                  <mat-datepicker-toggle [for]="$any(picker)" matIconSuffix></mat-datepicker-toggle>
                  <ngx-mat-datetime-picker [showSeconds]="true" #picker>
                    <ngx-mat-datepicker-actions>
                      <button ngxMatDatepickerApply>
                        <mat-icon>done</mat-icon>
                      </button>
                  </ngx-mat-datepicker-actions>
                  </ngx-mat-datetime-picker>
                </mat-form-field>
                <div *ngIf="!isValidDate(contractValidityStartDate)" style="color: red">
                  <small>
                    Please select a start date.
                  </small>
                </div>
              </div>
            </div>
          </ng-template>
        </c-accordion-item>
        <c-accordion-item #accordionItem3="cAccordionItem" [visible]="false">
          <ng-template cTemplateId="accordionHeaderTemplate">
          <div class="accordion-header"  (click)="accordionItem3.toggleItem()">
            <label> Restrict contract validity - end of contract</label>
            <mat-checkbox [(ngModel)]="isContractValidityEndPolicyChecked" (click)="handleCheckboxClick($event, 'isContractValidityEndPolicyChecked', accordionItem3)"></mat-checkbox>
          </div>
        </ng-template>
        <ng-template cTemplateId="accordionBody">
          <div class="accordion-body">
            <div cFormText style="color: #7f7f7f;">
              Please select the end date of the contract.
            </div>
            <div class="flex flex-col space-y-2">
              <mat-form-field>
                <mat-label>Select the date</mat-label>
                <input [ngxMatDatetimePicker]="picker" matInput [(ngModel)]="contractValidityEndDate">
                <mat-hint>DD/MM/YYYY, HH:MM:SS</mat-hint>
                <mat-datepicker-toggle [for]="$any(picker)" matIconSuffix></mat-datepicker-toggle>
                <ngx-mat-datetime-picker [showSeconds]="true" #picker>
                  <ngx-mat-datepicker-actions>
                    <button ngxMatDatepickerApply>
                      <mat-icon>done</mat-icon>
                    </button>
                </ngx-mat-datepicker-actions>
                </ngx-mat-datetime-picker>
              </mat-form-field>
              <div *ngIf="!isValidDate(contractValidityEndDate)" style="color: red">
                <small>
                  Please select an end date.
                </small>
              </div>
            </div>
          </div>
        </ng-template>
        </c-accordion-item>
      </c-accordion>
      <div *ngIf="this.isInvalidContractBookingPolicy || this.isInvalidContractValidityStartPolicy || this.isInvalidContractValidityEndPolicy" style="color: red">
        <small>
          Please check the selected POSSIBLE-X enforced policies.
        </small>
      </div>
      <br>
      <app-possible-x-enforced-policy-hints [isOfferingDataOffering]="isOfferingDataOffering()"></app-possible-x-enforced-policy-hints>
      <div class="flex justify-between pt-4">
        <button cButton color="secondary" matStepperPrevious shape="rounded-0">Back</button>
        <button (click)="createOffer()" [disabled]="!isServiceOfferingValid()" cButton color="primary" matStepperNext
                shape="rounded-0" type="submit">
          Create and Publish Offering
        </button>
      </div>
    </mat-step>

    <mat-step [editable]="false">
      <ng-template matStepLabel>Done</ng-template>
      <div class="min-h-16">
        <app-status-message
          #offerCreationStatusMessage
          [errorMessage]="'Offering creation failed.'"
          [infoMessage]="'Offering creation ongoing.'"
          [successMessage]="'Offering creation completed. Your (Data) Service Offering was successfully verified by a Gaia-X clearing house and published in the catalogue.'">
        </app-status-message>
      </div>
      <div class="flex justify-end pt-4">
        <button (click)="reset()" [disabled]="waitingForResponse" cButton color="primary" shape="rounded-0"
                type="submit">
          Close
        </button>
      </div>
    </mat-step>

    <!-- Icon overrides. -->
    <ng-template matStepperIcon="edit">
      <mat-icon>done</mat-icon>
    </ng-template>
  </mat-stepper>
</div>
